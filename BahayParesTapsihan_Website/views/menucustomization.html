<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Bahay Pares Tapsihan Customization Page</title>
    <link rel="icon" href="/images/bahaypareslogo.png" type="image/png">
    <link rel="stylesheet" type="text/css" href="/css/styles1.css" />
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.3/css/all.min.css">
</head>

<body>
    <header>
        <div class="header-content">
            <img class="logo" src="/images/bahaypareslogo.png" alt="Logo">

        </div>
        <nav>
            <a id="updateOrderLink" href="/Updateorder">Update Delivery Status</a>
            <a id="menuCustomizationLink" href="/menucustomization">Menu Update</a>
            <a id="orderHistoryLink" href="/OrderHistory">Order History</a>
            <a id="manageAccountsLink" href="/superadmin">Manage Accounts</a>
            <button id="logoutButton" style="display: none;">Logout</button>
        </nav>
    </header>

    <div id="loading-overlay">
        <div id="loading-spinner">
            <img src="/images/bahaypareslogo.png" alt="Loading..." loading="lazy" class="loader-image">
            <div class="loader"></div>
        </div>
    </div>

    <div class="container">

    </div>

    <div class="menu-container2">
        <h1>Customize Menu</h1>
        <form id="item-info2" class="menu-form">
            <div class="form-row">
                <div class="form-item" id="categoryDropdownContainer">
                    <label for="category2">Category:</label>
                    <select id="category2" name="category" required>
                        <option value="COVID MEALS">COVID MEALS</option>
                        <option value="SILOG MEALS">SILOG MEALS</option>
                        <option value="PARES MEALS">PARES MEALS</option>
                        <option value="ALA CARTE">ALA CARTE</option>
                        <option value="ISOLATION SPECIAL">ISOLATION SPECIAL</option>
                        <option value="EXTRA MEALS">EXTRA MEALS</option>
                        <option value="DELTA VARIANT">DELTA VARIANT</option>
                        <option value="BEVERAGES">BEVERAGES</option>
                        <option value="OTHERS">OTHERS</option>
                    </select>
                    
                        <select id="newCategory" name="newCategory" style="display: none;">
                            <option value="COVID MEALS">COVID MEALS</option>
                        <option value="SILOG MEALS">SILOG MEALS</option>
                        <option value="PARES MEALS">PARES MEALS</option>
                        <option value="ALA CARTE">ALA CARTE</option>
                        <option value="ISOLATION SPECIAL">ISOLATION SPECIAL</option>
                        <option value="EXTRA MEALS">EXTRA MEALS</option>
                        <option value="DELTA VARIANT">DELTA VARIANT</option>
                        <option value="BEVERAGES">BEVERAGES</option>
                        <option value="OTHERS">OTHERS</option>
                        </select>
                  
                    <label for="price">Price:</label>
                    <input type="number" id="price" name="price" required>
                </div>
                <div class="form-item">
                    <label for="name">Name:</label>
                    <input type="text" id="name" name="name" required>

                    <label for="description">Description:</label>
                    <input type="text" id="description" name="description" required>
                </div>
                <div class="form-item">
                    <label for="image">Image:</label>
                    <label for="image" class="file-input-container">
                        <input type="file" id="image" name="image" accept=".jpg, .jpeg" required>
                    </label>
                    <label for="availability">Availability:</label>
                    <input type="checkbox" id="availability" name="availability" class="bigger-checkbox">
                </div>
                <div class="form-item">
                    <label for="status">Status:</label>
                    <select id="status" name="status" required>
                        <option value="default"> Default </option>
                        <option value="sale">For Sale (Home Page)</option>
                        <option value="new">New</option>
                        <option value="featured">Featured (Home Page)</option>
                    </select>
                </div>
            </div>
            <div class="button-container">
                <button type="button" onclick="insertRecord()" class="add-to-cart-btn2">Insert Menu</button>
            </div>
        </form>

        <br>
        <hr>

        <table>
            <thead>
                <tr>
                    <th>Category</th>
                    <th>Name</th>
                    <th>Description</th>
                    <th>Image</th>
                    <th>Price</th>
                    <th>Availability</th>
                    <th>Status</th>
                    <th>Edit</th>
                    <th>Delete</th>

                </tr>
            </thead>
            <div class="search-container">
                <input type="text" id="menuSearch" placeholder="Search menu items...">
            </div>
            <tbody id="menuTableBody2">
                <!-- Table rows will be dynamically populated here -->
            </tbody>
        </table>

    </div>
    </div>
    </div>

    <br><br><br><br>

    <div class="footer">
        <div class="social-icons">
            <a href="https://www.facebook.com/tapsihansapasongbayog/" target="_blank"><i
                    class="fab fa-facebook-f"></i></a>
            <a href="#" target="_blank"><i class="fab fa-twitter"></i></a>
            <a href="#" target="_blank"><i class="fab fa-instagram"></i></a>
        </div>
        <div class="copyright">
            &copy; 2023 Bahay Pares Tapsihan – Dasmariñas.
        </div>
    </div>

    <script>
        // Add this at the beginning of your JavaScript code
        const loadingOverlay = document.getElementById('loading-overlay');
        const loadingSpinner = document.getElementById('loading-spinner');

        // Function to show the loading overlay
        function showLoading() {
            loadingOverlay.style.display = 'block';
            loadingSpinner.style.display = 'block';
        }

        // Function to hide the loading overlay
        function hideLoading() {
            loadingOverlay.style.display = 'none';
            loadingSpinner.style.display = 'none';
        }

        document.getElementById('image').addEventListener('change', function () {
            const fileInput = this;
            const allowedExtensions = ['.jpg', '.jpeg'];

            const fileName = fileInput.value.toLowerCase();
            const fileExtension = fileName.substring(fileName.lastIndexOf('.'));

            if (!allowedExtensions.includes(fileExtension)) {
                alert('Invalid file format. Please select a JPG or JPEG file.');
                fileInput.value = ''; // Clear the file input
            }
        });

        async function insertRecord() {
            const category = document.getElementById('category2').value;
            const name = document.getElementById('name').value;
            const description = document.getElementById('description').value;
            const imageInput = document.getElementById('image');
            const price = parseFloat(document.getElementById('price').value);
            const availability = document.getElementById('availability').checked;
            const status = document.getElementById('status').value;

            // Client-side validation for the image field
            if (imageInput.files.length === 0) {
                alert('Please select an image for the menu item.');
                return; // Prevent form submission
            }

            const formData = new FormData();
            formData.append('category', category);
            formData.append('name', name);
            formData.append('description', description);
            formData.append('image', imageInput.files[0]);
            formData.append('price', price);
            formData.append('availability', availability);
            formData.append('status', status);

            try {
                const response = await fetch('/insertmenu', {
                    method: 'POST',
                    body: formData,
                });

                const result = await response.json();
                alert(result.message);
                document.getElementById('item-info2').reset();
                fetchMenuData();
            } catch (error) {
                console.error('Error inserting record:', error);
                alert('An error occurred while inserting the record.');
            }
        }
        // TRY
        async function checkMenuItemExists(name, category) {
            try {
                const response = await fetch('/checkMenuItemExists', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        name,
                        category
                    }),
                });

                const result = await response.json();
                return result.exists;
            } catch (error) {
                console.error('Error checking menu item existence:', error);
                return false;
            }
        }

        async function deleteMenuItem(name) {
            try {
                const response = await fetch(`/deleteOrder/${name}`, {
                    method: 'DELETE',
                });

                const result = await response.json();
                alert(result.message);

                // Reload the table data after deletion
                fetchMenuData();
            } catch (error) {
                console.error('Error deleting menu item:', error);
                alert('An error occurred while deleting the menu item.');
            }
        }

        async function toggleAvailability(name, currentAvailability, button) {
            const availabilityCell = document.querySelector(
                `#menuTableBody2 tr[data-name="${name}"] .availability-cell`);
            const newAvailability = !currentAvailability;
            availabilityCell.textContent = newAvailability ? 'Loading....' : 'Loading....';

            try {
                const response = await fetch('/updatemenu', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        name,
                        availability: newAvailability
                    }),
                });

                const result = await response.json();
                alert(result.message);
                button.textContent = newAvailability ? 'Set Unavailable' : 'Set Available';

                fetchMenuData();
            } catch (error) {
                console.error('Error updating availability:', error);
                alert('An error occurred while updating availability.');
            }
        }


        async function fetchMenuData() {
            showLoading();
            try {
                const response = await fetch('/menufetch');
                const data = await response.json();

                const dataBody = document.getElementById('menuTableBody2');
                dataBody.innerHTML = '';

                data.forEach((menu) => {
                    const row = document.createElement('tr');
                    row.setAttribute('data-name', menu.name);

                    const categoryCell = document.createElement('td');
                    const nameCell = document.createElement('td');
                    const descriptionCell = document.createElement(
                        'td'); // Create a new cell for description
                    const imageCell = document.createElement('td');
                    const priceCell = document.createElement('td');

                    // Create the availability cell
                    const availabilityCell = document.createElement('td');
                    availabilityCell.classList.add('availability-cell'); // Add a class for easier selection

                    categoryCell.textContent = menu.category;
                    nameCell.textContent = menu.name;
                    descriptionCell.textContent = menu.description; // Populate description cell
                    // ...

                    const img = document.createElement('img');
                    img.src = `data:image/jpeg;base64,${menu.image}`;
                    img.alt = menu.name;
                    img.style.maxWidth = '100px';
                    imageCell.appendChild(img);

                    priceCell.textContent = menu.price;

                    // Create a button to toggle availability
                    const availabilityButton = document.createElement('button');
                    availabilityButton.textContent = menu.availability ? 'Set Unavailable' :
                        'Set Available';
                    availabilityButton.classList.add('toggle-button'); // Add the toggle-button class
                    availabilityButton.addEventListener('click', () => {
                        toggleAvailability(menu.name, menu.availability, availabilityButton);
                    });

                    availabilityCell.appendChild(availabilityButton);

                    const statusCell = document.createElement('td'); // Create a cell for the status
                    statusCell.textContent = menu.status; // Set the content of the status cell

                    // Create a button to delete the menu item
                    const deleteButton = document.createElement('button');
                    deleteButton.textContent = 'Delete';
                    deleteButton.classList.add('delete-button'); // Add a class for styling
                    deleteButton.addEventListener('click', () => {
                        deleteMenuItem(menu.name);
                    });

                    // Add the Delete button cell to the row
                    const deleteCell = document.createElement('td');
                    deleteCell.appendChild(deleteButton);

                    // Create an Edit button for each row
                    const editButton = document.createElement('button');
                    editButton.textContent = 'Edit';
                    editButton.classList.add('edit-button'); // Add a class for styling
                    editButton.addEventListener('click', () => {
                        editMenuItem(menu.name, menu.category);
                    });

                    // Add the Edit button cell to the row
                    const editCell = document.createElement('td');
                    editCell.appendChild(editButton);


                    // Append all cells to the row
                    row.appendChild(categoryCell);
                    row.appendChild(nameCell);
                    row.appendChild(descriptionCell); // Append description cell
                    row.appendChild(imageCell);
                    row.appendChild(priceCell);
                    row.appendChild(availabilityCell);
                    row.appendChild(statusCell);
                    row.appendChild(editCell);
                    row.appendChild(deleteCell);

                    dataBody.appendChild(row);
                    hideLoading();
                });
            } catch (error) {
                console.error('Error fetching menu data:', error);
            } finally {
                hideLoading();
            }
        }

        function editMenuItem(name, category) {
    
    // Hide the existing "Category" dropdown and show the "New Category" dropdown
    document.getElementById('category2').style.display = 'none';
    document.getElementById('newCategory').style.display = 'block';

    // Fetch the menu item data for editing
    fetch(`/getMenuItem/${category}/${name}`, {
        method: 'GET',
    })
    .then(response => response.json())
    .then(data => {
        // Populate the form fields with the data for editing
        document.getElementById('category2').value = data.category;
        document.getElementById('name').value = data.name;
        document.getElementById('description').value = data.description;
        document.getElementById('price').value = data.price;
        document.getElementById('availability').checked = data.availability;
        document.getElementById('status').value = data.status;
        // Populate the "New Category" dropdown
        document.getElementById('newCategory').value = data.category;

        // Check if the "Update" button already exists
        const updateButton = document.getElementById('update-menu-button');
        if (!updateButton) {
            // If it doesn't exist, create and add the "Update Menu" button
            const updateMenuButton = document.createElement('button');
            updateMenuButton.textContent = 'Update Menu';
            updateMenuButton.id = 'update-menu-button'; // Add an id for easier targeting
            updateMenuButton.classList.add('update-menu-btn'); // Add a class for styling
            updateMenuButton.addEventListener('click', () => {
                updateMenuItem(name); // Call the function to update the menu item
            });
            document.querySelector('.button-container').appendChild(updateMenuButton);

            // Hide the "Insert Menu" button
            const insertMenuButton = document.querySelector('.add-to-cart-btn2');
            insertMenuButton.style.display = 'none';
        } else {
            alert('Menu item not found for editing.');
        }
    })
    .catch(error => {
        console.error('Error fetching menu item for editing:', error);
    });
}

        async function updateMenuItem(name) {
    const newCategory = document.getElementById('newCategory').value; // Get the selected new category
    const category = document.getElementById('category2').value;
    const newName = document.getElementById('name').value;
    const description = document.getElementById('description').value;
    const price = parseFloat(document.getElementById('price').value);
    const availability = document.getElementById('availability').checked;
    const status = document.getElementById('status').value;

    // Hide the "New Category" dropdown and show the "Category" dropdown
    document.getElementById('category2').style.display = 'none';
    document.getElementById('newCategory').style.display = 'block'; 

    const formData = new FormData();
    formData.append('category', category);
    formData.append('name', name);
    formData.append('newCategory', newCategory); // Include the new category for updating
    formData.append('newName', newName);
    formData.append('description', description);
    formData.append('price', price);
    formData.append('availability', availability);
    formData.append('status', status);

            try {
                const response = await fetch('/updatemenuItem', {
                    method: 'POST',
                    body: formData,
                });

                const result = await response.json();
                alert(result.message);

                // Reset the form and show the Insert Menu button again
                document.getElementById('item-info2').reset();
                document.querySelector('.add-to-cart-btn2').style.display = 'block';

                // Remove the Update Menu button
                const updateButton = document.querySelector('.update-menu-btn');
                if (updateButton) {
                    updateButton.remove();
                }

                // Reload the table data after updating
                fetchMenuData();
            } catch (error) {
                console.error('Error updating menu item:', error);
                alert('An error occurred while updating the menu item.');
            }
        }
        //=================================================
        fetchMenuData();

        // Function to handle menu item search
        function searchMenuItems() {
            const searchInput = document.getElementById('menuSearch');
            const searchTerm = searchInput.value.toLowerCase();
            const tableRows = document.querySelectorAll('#menuTableBody2 tr');

            tableRows.forEach(row => {
                let rowContent = row.textContent.toLowerCase();
                if (rowContent.includes(searchTerm)) {
                    row.style.display = 'table-row';
                } else {
                    row.style.display = 'none';
                }
                });
        }

        // Add an event listener to the search input to call the searchMenuItems function
        document.getElementById('menuSearch').addEventListener('input', searchMenuItems);


        //LOGOUT FUNCTION
        document.addEventListener('DOMContentLoaded', function () {
            const logoutButton = document.getElementById('logoutButton');

            // Check if the user is authenticated by making a GET request to a route that
            // returns the user information when authenticated
            fetch('/check-auth', {
                    method: 'GET',
                })
                .then(response => response.json())
                .then(data => {
                    if (data.isAuthenticated) {
                        // If the user is authenticated, show the logout button
                        logoutButton.style.display = 'block';

                        // Add a click event listener to the logout button
                        logoutButton.addEventListener('click', function () {
                            // Display a confirmation dialog
                            const isConfirmed = window.confirm('Are you sure you want to logout?');

                            // Check if the user confirmed the logout
                            if (isConfirmed) {
                                // Send a logout request to the server when confirmed
                                fetch('/logout', {
                                        method: 'GET',
                                    })
                                    .then(response => response.json())
                                    .then(data => {
                                        if (data.message === 'Logout successful') {
                                            // Redirect to the login page or another page after logout
                                            window.location.href = '/';
                                        } else {
                                            console.error('Logout failed:', data.error);
                                        }
                                    })
                                    .catch(error => {
                                        console.error('Error during logout:', error);
                                    });
                            }
                        });
                    } else {
                        // If the user is not authenticated, keep the logout button hidden
                        logoutButton.style.display = 'none';
                    }
                })
                .catch(error => {
                    console.error('Error checking authentication:', error);
                });
        });
    </script>

</body>

</html>