<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Bahay Pares Tapsihan Transaction Page</title>
  <link rel="icon" href="/images/bahaypareslogo.png" type="image/png">
  <link rel="stylesheet" type="text/css" href="/css/main.css" />
  <link rel="stylesheet" type="text/css" href="/css/transactionpage.css" />
  <link rel="stylesheet" type="text/css" href="/css/styles1.css" />
  <!--JQuery-->
  <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.5.1/jquery.min.js"></script>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.2/css/all.min.css">
  <link rel="stylesheet" data-purpose="Layout StyleSheet" title="Web Awesome"
    href="/css/app-wa-02670e9412103b5852dcbe140d278c49.css?vsn=d">
  <link rel="stylesheet" href="https://site-assets.fontawesome.com/releases/v6.4.2/css/all.css">
  <link rel="stylesheet" href="https://site-assets.fontawesome.com/releases/v6.4.2/css/sharp-solid.css">
  <link rel="stylesheet" href="https://site-assets.fontawesome.com/releases/v6.4.2/css/sharp-regular.css">
  <link rel="stylesheet" href="https://site-assets.fontawesome.com/releases/v6.4.2/css/sharp-light.css">
</head>

<body>
  <header>
    <nav>
      <div class="logo-container">
        <a href="/"><img class="logo" src="/images/bahaypareslogo.png" alt="Logo"></a>
      </div>
      <div class="menu-icon" id="menuIcon">
        <i class="fas fa-bars fa-2x"></i>
        <input type="hidden" span id="welcomeUsername">
        <input type="hidden" id="userId" name="userId">
      </div>
      <div class="nav-items">
        <a href="/">Home</a>
        <a href="/menu">Menu</a>
        <a href="/Vieworder">Delivery Status</a>
        <a href="/AboutUs">About Us</a>
        <a href="/ContactUs">Customer Care</a>
      </div>
      <div class="dropdown">
        <button id="profileIcon" class="dropbtn" style="display: none;">
          <img src="/images/iconprofile.png" alt="Profile" width="45" height="45" class="profile-icon">

        </button>
        <div class="dropdown-content">
          <a href="/Profile">Profile</a>
          <a href="#" id="logoutButton">Logout</a>
        </div>
      </div>
    </nav>
    <div class="header-content">
    </div>

    <!-- Responsive Drawer -->
    <div class="drawer">
      <button id="closeDrawer" class="exit-button">
        <i class="fas fa-times"></i>
      </button>
      <div class="nav-items">
        <table>
          <tr>
            <td>
              <a href="/Profile" id="profileMenu" style="display: none;">
                <div class="profile-link">
                  <img src="/images/iconprofile.png" alt="Profile">
                </div>
              </a>
            </td>
          </tr>
          <tr>
            <td style="text-align: left;"><a href="/">Home</a></td>
          </tr>
          <tr>
            <td style="text-align: left;"><a href="/menu">Menu</a></td>
          </tr>
          <tr>
            <td style="text-align: left;"><a href="/Vieworder">Delivery Status</a></td>
          </tr>
          <tr>
            <td style="text-align: left;"><a href="/AboutUs">About Us</a></td>
          </tr>
          <tr>
            <td style="text-align: left;"><a href="/ContactUs">Customer Care</a></td>
          </tr>

          <tr></tr>
          <tr>
            <td>
              <a href="#" id="logoutMenu" style="display: none;">Logout</a>
          </tr>

        </table>
      </div>
    </div>
  </header>
  <div class="parallax-background"></div>


  <br>
  <div class="transaction_container">
    <div class="containers" style="max-width: 700px;">
      <h2>DELIVERING TO</h2>
      <p id="delivery-fee-warning" class="warning">
        <i class="fas fa-truck"></i> Delivery fee may vary depending on your location.
      </p>

      <div class="address-section">
        <div class="containers" style="max-width: 100%;">
          <table class="options-table no-hover">
            <form method="POST" action="">
              <div>
                <h3><i class="fas fa-map-marker-alt"></i> Enter Your Address</h3>
              </div>
              <hr>

              <div class="col-md-6 mb-3" id="region-container">
                <label for="region" class="form-label">Region</label>
                <select class="form-select" id="region"></select>
              </div>

              <div class="col-md-6 mb-3" id="province-container">
                <label for="province" class="form-label">Province</label>
                <select class="form-select" id="province"></select>
              </div>

              <div class="col-md-6 mb-3" id="city-container">
                <label for="city" class="form-label">City/Municipality</label>
                <select class="form-select" id="city"></select>
              </div>

              <div class="col-md-6 mb-3" id="barangay-container">
                <label for="barangay" class="form-label">Barangay</label>
                <select class="form-select" id="barangay"></select>
              </div>
              <div class="col-md-6 mb-3" id="street-container">
                <label for="street-text" class="form-label">Street Name, Building, House No.*</label>
                <input type="text" class="form-control form-control-md" name="street_text" id="street-text">
              </div>
            </form>
          </table>
        </div>
      </div>

      <h2>PAYMENT</h2>
      <div class="containers" style="max-width: 100%;">
        <div class="payment-section">
          <table class="options-table no-hover">
            <tr>
              <td>
                <select name="pay">
                  <option value="CoD">Cash on Delivery (CoD)</option>
                  <option value="GCash">GCash</option>
                </select>
              </td>
            </tr>
          </table>
        </div>
      </div>
      <div class="table.center">

        <h2>DISCOUNT</h2>
        <div class="containers" style="max-width: 100%;">
          <!-- Add this section within the "address-section" div -->
          <div class="discount-section">
            <table class="options-table no-hover">
              <tr>
                <td>
                  <p>ID must be presented.</p>
                  <select id="discount-select" onchange="toggleDiscountFields()">
                    <option value="none">None</option>
                    <option value="senior">Senior Citizen Card</option>
                    <option value="pwd">PWD Card</option>
                  </select>
                </td>
              </tr>
              <tr id="card-name-row" style="display: none;">
                <td><label>Name of Card:</label></td>
                <td><input type="text" id="card-name"></td>
              </tr>
              <tr id="card-id-row" style="display: none;">
                <td><label>ID No:</label></td>
                <td><input type="number" id="card-id"></td>
              </tr>
            </table>
            <button class="confirm-order-btn" onclick="applyDiscount()">Apply Discount</button>
            <button class="reset-discount-btn" onclick="resetDiscount()">Reset</button>
          </div>
        </div>

        <div class="order-details">
          <h2>ORDER SUMMARY</h2>
          <table>
            <tbody id="order-body" class="options-table no-hover">
              <!-- Data from MongoDB will be inserted here -->
            </tbody>
            <tfoot id="order-footer">
              <!-- Add the following rows with left-aligned and right-aligned cells -->
              <tr style="background-color: #ebebeb;">
                <td class="left-align">Subtotal</td>
                <td class="right-align" id="sub-total"></td>
              </tr>
              <tr style="background-color: #ebebeb;">
                <td class="left-align">Delivery Fee</td>
                <td class="right-align" id="delivery-fee"></td>
              </tr>
              <tr style="background-color: #ebebeb;">
                <td class="left-align">Discount</td>
                <td class="right-align" id="customer-discount">Php 0.00</td>
              </tr>
              <tr style="background-color: #ebebeb;">
                <td class="left-align">Total</td>
                <td class="right-align" id="total-price"></td>
              </tr>
            </tfoot>
          </table>
        </div>


      </div>
      <table class="options-table no-hover" style="display: none;">
        <table class="options-table no-hover">
          <tr>
            <td></td>
            <td>
              <button class="confirm-order-btn" onclick="buy()">Place Order</button>
            </td>
            <td>
              <a href="/menu" class="button-like-link" style="background-color: #f44336; color: white;">Cancel</a>
            </td>
          </tr>
        </table>
    </div>
  </div>

  <!-- Overlay for "Restaurant Closed" -->
  <div id="overlay" class="overlay">
    <div class="overlay-content">
      <h2>Currently Closed</h2>
      <p>Sorry, but Bahay Pares Tapsihan is currently closed. Please try again during our operating hours.</p>
      <br>
      <p>Thank you!</p>
      <br>
      <button onclick="redirectToHomePage()">OK</button>
    </div>
  </div>

  <br><br>

  <div class="footer">
    <div class="social-icons">
      <a href="https://www.facebook.com/tapsihansapasongbayog/" target="_blank"><i class="fab fa-facebook-f"></i></a>
      <a href="#" target="_blank"><i class="fab fa-twitter"></i></a>
      <a href="#" target="_blank"><i class="fab fa-instagram"></i></a>
    </div>
    <div class="copyright">
      &copy; 2023 Bahay Pares Tapsihan – Dasmariñas.
    </div>
  </div>

  <script>
    window.onload = function () {
      checkRestaurantState();
      toggleDiscountFields();
      fetchLatestOrder('Dasmariñas');
    }

    // Function to check restaurant state and display overlay
    function checkRestaurantState() {
      fetch('/checkRestaurantState')
        .then(response => response.json())
        .then(data => {
          if (data.state === 'Closed') {
            document.getElementById('overlay').style.display = 'block';
          }
        })
        .catch(error => {
          console.error('Error:', error);
        });
    }

    function redirectToHomePage() {
      window.location.href = '/';
    }

    const username = sessionStorage.getItem('username');
    const userId = sessionStorage.getItem('userId');
    async function getUserId() {
      try {
        const response = await fetch('/getUserId');
        const data = await response.json();
        return data.userId; // Assuming /getUserId always returns the user ID or null
      } catch (error) {
        console.error('Error fetching user ID:', error);
        return null;
      }
    }

    let discountApplied = false;
    async function applyDiscount() {
      if (discountApplied) {
        return;
      }

      // Get the selected discount option
      const discountSelect = document.getElementById('discount-select');
      const selectedDiscount = discountSelect.value;

      // Get the card name and ID input values
      const cardNameInput = document.getElementById('card-name');
      const cardIdInput = document.getElementById('card-id');
      const cardName = cardNameInput.value;
      const cardId = cardIdInput.value;

      // Get the total price element
      const subtotalelement = document.getElementById('sub-total');
      const currentTotal = parseFloat(subtotalelement.textContent.replace('Php', ''));

      if (!cardName || !cardId) {
        alert('Please fill in the name of the card and ID number.');
        return;
      }

      // Calculate the discount amount based on the selected option
      let discountAmount = 0; // Default to no discount

      if (selectedDiscount !== "none") {
        discountAmount = 0.05; // 5% discount for options other than "None"
      }
      const customerDiscount = parseFloat((currentTotal * discountAmount).toFixed(2));

      const response = await fetch('/latestorder');
      const latestOrder = await response.json();
      orderId = latestOrder.orderId;

      try {
        // Update the delivery status to "Delivering" in the "CustomerOrders" collection
        const updateResponse = await fetch('/updateDiscount', {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
          },
          body: JSON.stringify({
            orderId,
            customerDiscount, // Set the new delivery status here
          }),
        });
        // Rest of your code...
      } catch (error) {
        console.error('Error updating discount:', error);
        alert('An error occurred while updating the discount.');
      }


      // Set the discountApplied flag to true
      discountApplied = true;

      // Disable the "Apply Discount" button
      const applyDiscountButton = document.querySelector('.confirm-order-btn');
      applyDiscountButton.disabled = true;

      selectedCity = 'Dasmariñas';

      fetchLatestOrder(selectedCity);

      alert('Discount applied!');
    }


    // Function to remove the discount
    async function resetDiscount() {
      discountApplied = false;

      const response = await fetch('/latestorder');
      const latestOrder = await response.json();
      orderId = latestOrder.orderId;

      try {
        // Update the delivery status to "Delivering" in the "CustomerOrders" collection
        const updateResponse = await fetch('/updateDiscount', {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
          },
          body: JSON.stringify({
            orderId,
            customerDiscount: 0.00, // Set the new delivery status here
          }),
        });
        // Rest of your code...
      } catch (error) {
        console.error('Error updating discount:', error);
        alert('An error occurred while updating the discount.');
      }

      selectedCity = 'Dasmariñas';

      fetchLatestOrder(selectedCity);

      alert('Discount reset!');
    }


    let latestOrderId = '';
    // Add an event listener to the 'city' select element
    const citySelect = document.getElementById('city');

    citySelect.addEventListener('change', () => {
      const selectedCity = citySelect.options[citySelect.selectedIndex].text.trim();
      fetchLatestOrder(selectedCity); // Call fetchLatestOrder with the selected city
    });


    // Add this function to your JavaScript
    function toggleDiscountFields() {
      const discountSelect = document.getElementById('discount-select');
      const cardNameRow = document.getElementById('card-name-row');
      const cardIdRow = document.getElementById('card-id-row');
      const applyDiscountButton = document.querySelector('.confirm-order-btn');
      const resetDiscountButton = document.querySelector('.reset-discount-btn');

      const selectedDiscount = discountSelect.value;

      if (selectedDiscount === 'none') {
        // If "None" is selected, hide the card name and ID fields
        cardNameRow.style.display = 'none';
        cardIdRow.style.display = 'none';

        // Hide the "Apply Discount" button
        applyDiscountButton.style.display = 'none';
        resetDiscountButton.style.display = 'block';
      } else {
        // If any other option is selected, show the card name and ID fields
        cardNameRow.style.display = 'table-row';
        cardIdRow.style.display = 'table-row';

        // Show the "Apply Discount" button
        applyDiscountButton.style.display = 'block';
        resetDiscountButton.style.display = 'none';
      }
    }

    async function fetchLatestOrder(selectedCity = '') {
      try {
        // Fetch the user ID
        const userId = await getUserId();

        if (!userId) {
          alert('User ID not found.');
          return;
        }

        const [latestOrderResponse, deliveryFeeResponse] = await Promise.all([
          fetch('/latestorder'),
          fetch(`/deliveryfee?location=${selectedCity}`), // Use backticks for interpolation
        ]);

        const latestOrder = await latestOrderResponse.json();
        const deliveryFee = await deliveryFeeResponse.json();

        // Access the table body element
        const dataBody = document.getElementById('order-body');

        // Access the subtotal element
        const subtotalelement = document.getElementById('sub-total');

        const discountElement = document.getElementById('customer-discount');
        const deliveryFeeElement = document.getElementById('delivery-fee');

        // Access the total element
        const totalElement = document.getElementById('total-price');

        // Clear any existing content
        dataBody.innerHTML = '';
        subtotalelement.textContent = ''; // Clear total price
        discountElement.textContent = ''; // Clear total price
        deliveryFeeElement.textContent = 'Php 0.00'; // Set initial delivery fee to 0
        totalElement.textContent = '';

        // Check if the latestOrder is not empty
        if (latestOrder) {
          const orderId = latestOrder.orderId;
          const cartItems = latestOrder.cartItems;
          const customerDiscount = latestOrder.customerDiscount;
          let totalPrice = 0;

          // Loop through the cartItems and create table rows
          cartItems.forEach((item, index) => {
            const row = document.createElement('tr');

            // Create a cell for the item name and quantity (left-aligned)
            const listItemCell = document.createElement('td');
            listItemCell.textContent = `${item.quantity} ${item.name}`;
            row.appendChild(listItemCell);

            // Create a cell for the price (right-aligned)
            const priceCell = document.createElement('td');
            priceCell.textContent = `Php ${item.price.toFixed(2)}`;
            priceCell.style.textAlign = 'right'; // Align the cell content to the right
            row.appendChild(priceCell);

            dataBody.appendChild(row);

            // Update total price
            totalPrice += item.price * item.quantity;
          });

          // Display the total price at the end of the table
          subtotalelement.textContent = `Php ${totalPrice.toFixed(2)}`;
          totalElement.textContent = `Php ${totalPrice.toFixed(2)}`;

          // Display the customer discount if it's greater than 0 
          if (customerDiscount > 0) {
            discountElement.textContent = `- Php ${customerDiscount.toFixed(2)}`;
            deliveryFeeElement.textContent = `Php ${deliveryFee.deliveryfee.toFixed(2)}`;
            totalElement.textContent =
              `Php ${((totalPrice - customerDiscount) + deliveryFee.deliveryfee).toFixed(2)}`;
          } else {
            discountElement.textContent = `Php ${customerDiscount.toFixed(2)}`;
            deliveryFeeElement.textContent = `Php ${deliveryFee.deliveryfee.toFixed(2)}`;
            totalElement.textContent = `Php ${(totalPrice + deliveryFee.deliveryfee).toFixed(2)}`;
          }
        }
      } catch (error) {
        console.error('Error fetching data:', error);
      }
    }

    async function buy() {
      try {
        const subtotalelement = parseFloat(document.getElementById('sub-total').textContent.replace('Php', ''));
        const deliveryfee = parseFloat(document.getElementById('delivery-fee').textContent.replace('Php', ''));
        const totalPrice = parseFloat(document.getElementById('total-price').textContent.replace('Php', ''));
        const formattedTotalPrice = totalPrice.toFixed(2);

        const discountSelect = document.getElementById('discount-select');
        const selectedDiscount = discountSelect.value;

        const cardNameInput = document.getElementById('card-name');
        const cardIdInput = document.getElementById('card-id');
        const cardName = cardNameInput.value;
        const cardId = cardIdInput.value;

        // Get selected payment method
        const selectedPaymentMethod = document.querySelector('select[name="pay"]').value;

        // If the selected payment method is not GCash, proceed with other payment methods
        const regionSelect = document.getElementById('region');
        const provinceSelect = document.getElementById('province');
        const citySelect = document.getElementById('city');
        const barangaySelect = document.getElementById('barangay');
        const streetInput = document.getElementById('street-text');

        const region = regionSelect.options[regionSelect.selectedIndex].text.trim();
        const province = provinceSelect.options[provinceSelect.selectedIndex].text.trim();
        const city = citySelect.options[citySelect.selectedIndex].text.trim();
        const barangay = barangaySelect.options[barangaySelect.selectedIndex].text.trim();
        const street = streetInput.value.trim();

        if (!region || !province || !city || !barangay || !street) {
          alert('Please select all location fields.');
          return;
        }

        const location = `${region}, ${province}, ${city}, ${barangay}, ${street}`;
        sessionStorage.setItem('location', location);

        const buyresponse = await fetch('/latestorder');
        const latestOrder = await buyresponse.json();

        const userId = latestOrder.userId;
        const orderId = latestOrder.orderId;
        const orderItems = latestOrder.cartItems;
        const customerDiscount = latestOrder.customerDiscount;
        const username = latestOrder.username;
        const user_email = latestOrder.email;
        const user_phone = latestOrder.phone;

        if (selectedPaymentMethod === 'GCash') {
          // If GCash is selected as the payment method, generate a checkout URL with Bux
          const buxAPIKey = '062e92d1b56ea9dae98638fcb456828f'; // Replace with your Bux API Key

          const buxRequest = {
            req_id: orderId, // Replace with your unique identifier
            client_id: '000001fca3', // Replace with your client ID
            amount: formattedTotalPrice,
            description: 'Bahay Pares Tapsihan Online Order Payment',
            expiry: 2, // Set the expiry in hours
            email: user_email, // Replace with the buyer's email
            contact: user_phone, // Replace with the buyer's mobile number
            name: username, // Replace with the buyer's name
            notification_url: '/notification_url', // Replace with your notification URL
            redirect_url: 'http://localhost:3000/Vieworder', // Replace with your redirect URL
            param1: orderItems,
            enabled_channels: ["711_direct",
              "grabpay",
              "gcash"
            ],
          };

          const buxCheckoutResponse = await fetch('/open/checkout/', {
            method: 'POST',
            headers: {
              'Content-Type': 'application/json',
              'x-api-key': buxAPIKey,
            },
            body: JSON.stringify(buxRequest),
          });

          console.log(buxCheckoutResponse.status); // Check the HTTP status code

          const buxData = await buxCheckoutResponse.json();
          const buxCheckoutUrl = buxData.url; // Use the received URL

          // Open the Bux checkout page in a new tab
          window.location.href = buxCheckoutUrl;

          // Payment was successful, add your code here
          const order = {
            userId,
            orderId,
            items: orderItems,
            location,
            discount: {
              SelectedDiscount: selectedDiscount,
              CardName: cardName,
              CardId: cardId,
              CustomerDiscount: customerDiscount,
            },
            totalprice: {
              Subtotal: subtotalelement,
              DeliveryFee: deliveryfee,
              Discount: customerDiscount,
              Total: formattedTotalPrice,
            },
            paymentmethod: selectedPaymentMethod,
            deliverystatus: "Pending",
          };

          const response = await fetch('/storeOrder', {
            method: 'POST',
            headers: {
              'Content-Type': 'application/json',
            },
            body: JSON.stringify(order),
          });

          if (response.ok) {
            console.log('Order data stored successfully.');
            alert('Order placed successfully!');
          } else {
            console.error('Error storing order data.');
            alert('Error occurred while placing the order. Please try again.');
          }
        } else {
          const order = {
            userId,
            orderId,
            items: orderItems,
            location,
            discount: {
              SelectedDiscount: selectedDiscount,
              CardName: cardName,
              CardId: cardId,
              CustomerDiscount: customerDiscount,
            },
            totalprice: {
              Subtotal: subtotalelement,
              DeliveryFee: deliveryfee,
              Discount: customerDiscount,
              Total: formattedTotalPrice,
            },
            paymentmethod: selectedPaymentMethod,
            deliverystatus: "Pending",
          };

          const response = await fetch('/storeOrder', {
            method: 'POST',
            headers: {
              'Content-Type': 'application/json',
            },
            body: JSON.stringify(order),
          });

          if (response.ok) {
            console.log('Order data stored successfully.');
            alert('Order placed successfully!');
            window.location.href = '/Vieworder';
          } else {
            console.error('Error storing order data.');
            alert('Error occurred while placing the order. Please try again.');
          }
        }
      } catch (error) {
        console.error('Error during buy process:', error);
        alert('An error occurred while processing the order. Please try again.');
      }
    }

    document.addEventListener('DOMContentLoaded', function () {
      // Click event handler for the Profile link
      const profileLink = document.querySelector('a3[href="/Profile"]');
      profileLink.addEventListener('click', function (event) {
        event.preventDefault(); // Prevent the default navigation behavior
        const welcomeUsername = document.getElementById('welcomeUsername').textContent;
        sessionStorage.setItem('welcomeUsername', welcomeUsername);
        window.location.href = '/Profile'; // Navigate to the "Profile" page
      });
    });

    //LOGOUT FUNCTION
    document.addEventListener('DOMContentLoaded', function () {
      const logoutButton = document.getElementById('logoutButton');
      const Profile = document.getElementById('profileIcon');

      // Check if the user is authenticated by making a GET request to a route that
      // returns the user information when authenticated
      fetch('/check-auth', {
          method: 'GET',
        })
        .then(response => response.json())
        .then(data => {
          if (data.isAuthenticated) {
            logoutButton.style.display = 'block';
            Profile.style.display = 'block';

            // Add a click event listener to the logout button
            logoutButton.addEventListener('click', function () {
              // Display a confirmation dialog
              const isConfirmed = window.confirm('Are you sure you want to logout?');

              // Check if the user confirmed the logout
              if (isConfirmed) {
                // Send a logout request to the server when confirmed
                fetch('/logout', {
                    method: 'GET',
                  })
                  .then(response => response.json())
                  .then(data => {
                    if (data.message === 'Logout successful') {
                      // Redirect to the login page or another page after logout
                      window.location.href = '/';
                    } else {
                      console.error('Logout failed:', data.error);
                    }
                  })
                  .catch(error => {
                    console.error('Error during logout:', error);
                  });
              }
            });
          } else {
            Profile.style.display = 'none';
            logoutButton.style.display = 'none';
          }
        })
        .catch(error => {
          console.error('Error checking authentication:', error);
        });
    });

    const parallaxBackground = document.querySelector('.parallax-background');

    window.addEventListener('scroll', function () {
      const scrollPosition = window.scrollY;
      // Adjust the image height based on the scroll position
      parallaxBackground.style.height = 400 - scrollPosition * 0.5 + 'px';
    });
  </script>
</body>

</html>

<script src="/javascript/ph-address-selector.js"></script>